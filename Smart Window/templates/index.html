<!doctype html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--jquery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!-- static CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename="styles/style.css" )}}" />
    <script>
          // Set global variable
    var watchID;

    function showPosition() {
        if(navigator.geolocation) {
            watchID = navigator.geolocation.watchPosition(successCallback);
        } else {
            alert("Sorry, your browser does not support HTML5 geolocation.");
        }
    }

    function successCallback(position) {


        // Check position has been changed or not before doing anything
        if(prevLat != position.coords.latitude || prevLong != position.coords.longitude){

            // Set previous location
            var prevLat = position.coords.latitude;
            var prevLong = position.coords.longitude;

            // Get current position
            var positionInfo =   position.coords.latitude + ", " + position.coords.longitude ;
           // document.getElementById("result").innerHTML = positionInfo;
             $.ajax({
                type: "POST",
                url: "/get_geolocation_data",
                contentType: "application/json",
                data: JSON.stringify({loc: positionInfo}),
                dataType: "json",
                success: function(response) {

                    console.log(response);
                },
                error: function(err) {
                    console.log(err);
                }
            });

        }

    }
    // Initialise the whole system (above)
    window.onload = showPosition;
    </script>

</head>
<body>

<h5>Live Streaming</h5>

<div class="container">

    <video id="video" width="640" height="480" autoplay></video>
    <button id="snap">Snap Photo</button>
    <canvas id="canvas" width="640" height="480"></canvas>

</div>

<script>
// Elements for taking the snapshot
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
var video = document.getElementById('video');

// Get access to the camera!
if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // Not adding `{ audio: true }` since we only want video now
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        //video.src = window.URL.createObjectURL(stream);
        video.srcObject = stream;
        video.play();
    });
}

// Trigger photo take
 function  data() {
	context.drawImage(video, 0, 0, 640, 480);
	var dataURL = canvas.toDataURL('image/jpeg', 1.0);
	console.log(typeof(dataURL));
	$.ajax({
                type: "POST",
                url: "/get_image_data",
                contentType: "application/json",
                data: JSON.stringify({image: dataURL}),
                dataType: "json",
                success: function(response) {

                    console.log(response);
                },
                error: function(err) {
                    console.log(err);
                }
            });



}

$(document).ready(function(){
 setInterval(data,10000);
});

</script>
</body>
</html>